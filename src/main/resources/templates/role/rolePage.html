<!DOCTYPE html>
<html>
    <head>
        <#include "/INC_HEAD.HTML">
    </head>
    
    <body>
    
        <table id="dg" class="easyui-datagrid" style="height:100%;width:100%;"
                url="queryRoleJson"
                toolbar="#toolbar" fit="true"
                rownumbers="true" fitColumns="true" singleSelect="true"
                striped="true" loadMsg="数据加载中，请等待..."
                pageSize="20" pagination="true"
                pageList="[1,2,10,20]">
            <thead>
                <tr>
                    <th field="rolename" width="40">角色名称</th>
                    <th field="projectname" width="50">项目名称</th> 
                    <th field="subsystemname" width="50">子系统名称</th>
                    <th field="remark" width="40">备注</th>
                    <th field="createtime" width="30">创建时间</th>
                    <th field="updatetime" width="30">修改时间</th>
                </tr>
            </thead>
        </table>
        <div id="toolbar">
            <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-add" plain="true" onclick="add();">新增</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-edit" plain="true" onclick="mod();">修改</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-remove" plain="true" onclick="del();">删除</a>
        </div>
        
        <div id="dlg" class="easyui-dialog" style="width:400px" data-options="closed:true,modal:true,border:'thin',buttons:'#dlg-buttons'">
            <form id="fm" method="post" novalidate style="margin:0;padding:20px 50px;">
                <h3>角色信息</h3>
                <div style="margin-bottom:10px">
                    <input name="rolename" class="easyui-textbox" required="true" label="角色名称:" style="width:100%;">
                </div>
                <div style="margin-bottom:10px">
                    <input id="projectid" name="projectid" required="true" label="项目名称:" style="width:100%;" data-options="editable:false,panelHeight:'auto'">
                </div>
                <div style="margin-bottom:10px">
                    <input id="subsystemid" name="subsystemid" required="true" label="子系统名称:" style="width:100%;" data-options="editable:false,panelHeight:'auto'">
                </div>
                <div style="margin-bottom:10px">
                    <input name="remark" class="easyui-textbox" label="备注:" style="width:100%;height:60px;" data-options="multiline:true">
                </div>
            </form>
        </div>
        <div id="dlg-buttons">
            <a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-ok" onclick="save();" style="width:90px">保存</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" onclick="javascript:$('#dlg').dialog('close');" style="width:90px">取消</a>
        </div>
        
    </body>
    
<script type="text/javascript">
var url;
function add(){
    $('#dlg').dialog('open').dialog('center').dialog('setTitle','新增');
    $('#fm').form('clear');
    url = 'addRole';
    
    $("#projectid").combobox({
        valueField:'projectid',
        textField:'projectname',
        url:'../project/queryProjectCombobox',
        onLoadSuccess:function(){ //默认选中第一条数据
            var data= $(this).combobox("getData");
            if (data.length > 0) {
                $('#projectid').combobox('select', data[0].projectid);
            }
        }
    });
    
    $("#subsystemid").combobox({
        valueField:'subsystemid',
        textField:'subsystemname',
        url:'../subsystem/querySubSystemCombobox',
        onLoadSuccess:function(){ //默认选中第一条数据
            var data= $(this).combobox("getData");
            if (data.length > 0) {
                $('#subsystemid').combobox('select', data[0].subsystemid);
            }
        }
    });
}

function mod(){
    var row = $('#dg').datagrid('getSelected');
    if (row){
        $('#dlg').dialog('open').dialog('center').dialog('setTitle','修改');
        $('#fm').form('load',row);
        url = 'modRole?roleid='+row.roleid;
        
        $("#projectid").combobox({
            valueField:'projectid',
            textField:'projectname',
            url:'../project/queryProjectCombobox',
            onLoadSuccess:function(){ //默认选中第一条数据
                var data= $(this).combobox("getData");
                if (data.length > 0) {
                    $('#projectid').combobox('select', row.projectid);
                }
            }
        });
    }
}

function save(){
    $('#fm').form('submit',{
        url: url,
        dataType:"json",
        onSubmit: function(){
            return $(this).form('validate');
        },
        success: function(result){
            var result = eval('('+result+')');
            if (result.nResult=="0"){
                $('#dlg').dialog('close');        // close the dialog
                $('#dg').datagrid('reload');    // reload the user data
            } else {
                $.messager.show({
                    title: '提示',
                    msg: result.msg
                });
            }
        }
    });
}

function del(){
    var row = $('#dg').datagrid('getSelected');
    if (row){
        $.messager.confirm('确认','请确认删除',function(r){
            if (r){
                $.post('delRole',{roleid:row.roleid},function(result){
                    if (result.nResult=="0"){
                        $('#dg').datagrid('reload');    // reload the user data
                    } else {
                        $.messager.show({    // show error message
                            title: '提示',
                            msg: result.msg
                        });
                    }
                },'json');
            }
        });
    } else {
        $.messager.show({
            title: '提示',
            msg: "请选择一行"
        });
    }
}
</script>

</html>